SELECT 
 C7.C7_PRODUTO
,C7.C7_DESCRI
,C7.C7_DESCRI
,C7.C7_NUM
,A2.A2_COD COD_FORNECE
,A2.A2_NOME FORNECEDOR
,C7.C7_FSFLUIG
,C7.C7_EMISSAO 
,D1_DTDIGIT DATA_ULT_COMPRA
,D1.D1_VUNIT VALOR_ULTIMA_COMPRA
,C7.C7_PRECO VALOR_UNIT_PEDIDO

FROM
  SC7010 C7
   LEFT JOIN
   SD1010 D1
    ON
      D1.D1_COD         = C7.C7_PRODUTO
	  AND D1.D1_FORNECE = C7.C7_FORNECE
      AND D1.D1_LOJA   = C7.C7_LOJA
      AND D1.D_E_L_E_T_     <> '*'
 INNER JOIN
   SA2010 A2
    ON
      A2.A2_COD        = C7.C7_FORNECE
      AND A2.A2_LOJA   = C7.C7_LOJA
      AND A2.D_E_L_E_T_     <> '*'

	 WHERE C7.D_E_L_E_T_  <> '*'
      AND C7.C7_CONAPRO  = 'L'
      AND C7.C7_FSFLUIG <> '0'
      AND C7_EMISSAO BETWEEN '20200701' AND '20200701'
	  AND C7_FILIAL = '010101'
	  AND D1.D1_COD+C7.C7_EMISSAO IN (
	    SELECT MAX (D1_DTDIGIT)
        FROM SD1010 (NOLOCK) 
        WHERE
          D1_DTDIGIT <= C7.C7_EMISSAO
           AND D1_QUANT > 0
	     )
     GROUP BY 
	 C7.C7_PRODUTO
    ,C7.C7_DESCRI
    ,C7.C7_NUM
    ,A2.A2_COD 
    ,A2.A2_NOME 
    ,C7.C7_FSFLUIG
    ,C7.C7_EMISSAO
	,D1_DTDIGIT 
    ,D1.D1_VUNIT 
    ,C7.C7_PRECO 
	ORDER BY C7.C7_PRODUTO




	SELECT D2_EMISSAO, D2_DOC,D2_COD FROM SD2010 
WHERE D2_FILIAL='020101'
and D2_COD+D2_EMISSAO IN  
(
SELECT D2_COD+MAX(D2_EMISSAO) EMISSAO FROM SD2010 WHERE D2_COD IN
(
'S10B00012' 
,'S05J00001'  
,'S20J00003'  
,'S05E00001'  
,'S05E00006' 
,'S20H00010'  
,'S20H00004' 
) 
AND D_E_L_E_T_<>'*'
GROUP BY D2_COD
)

GROUP BY D2_DOC,D2_COD, D2_EMISSAO

ORDER BY D2_COD

